//Restrict Public IP address for compute VM instance
//import "tfplan-functions" as tfplan
//import "tfplan/v3" as tfplan
import "tfplan/v2" as tfplan

//allComputeInstances = tfplan.find_resources("google_compute_instance")

allComputeInstances = filter tfplan.resource_changes as _, resource_changes {
	resource_changes.type is "google_compute_instance" and
		resource_changes.mode is "managed" and
		(resource_changes.change.actions contains "create" or
			resource_changes.change.actions is ["update"])
}

status = true
for allComputeInstances as _, rc {
	if (rc.change.after contains "network_interface")	{
			print("Yes - Network Interface Present", rc.change.after)
		if (rc.change.after.network_interface not in [null, []] and rc.change.after.network_interface[0] contains "network") {
			print("Yes - NETWORK Present", rc.change.after.network_interface[0], rc.change.after.network_interface[1], rc.change.after.network_interface[2], rc.change.after.network_interface[3], rc.change.after.network_interface[4])
			if (rc.change.after.network_interface[4] contains "access_config") {
			status = false
			print ("Policy Validation - Restricting Public IP Access for Compute Instance")    
			}
		}	
	}
}

main = rule {
	status
}
